#!/usr/bin/env python3
from scapy.all import *

iface = "eth1"
src_mac = get_if_hwaddr(iface)

def send_gvrp_join(vlan):
    pkt = (
        Ether(src=src_mac, dst="01:80:c2:00:00:21") /
        LLC(dsap=0x42, ssap=0x42, ctrl=0x03) /
        SNAP(OUI=0x000000, code=0x0001) /           # 必须加这一层！！！
        Raw(load=(
            b'\x00\x01' +                           # Protocol ID: 0x0001 (VLAN)
            b'\x01' +                               # Attribute Type: 1 (VLAN)
            b'\x05' +                               # Length: 5 (2字节VLAN + 3字节pad)
            b'\x02' +                               # Event: 2 = JoinIn
            vlan.to_bytes(2, 'big') +               # VLAN ID (big-endian)
            b'\x00\x00\x00' +                       # Padding
            b'\x00'                                 # End of Mark
        ))
    )
    sendp(pkt, iface=iface, verbose=0)
    print(f"[+] Join VLAN {vlan}")

def send_gvrp_leave(vlan):
    pkt = (
        Ether(src=src_mac, dst="01:80:c2:00:00:21") /
        LLC(dsap=0x42, ssap=0x42, ctrl=0x03) /
        SNAP(OUI=0x000000, code=0x0001) /
        Raw(load=(
            b'\x00\x01' +
            b'\x01' +
            b'\x05' +
            b'\x00' +                               # Event: 0 = LeaveEmpty
            vlan.to_bytes(2, 'big') +
            b'\x00\x00\x00' +
            b'\x00'
        ))
    )
    sendp(pkt, iface=iface, verbose=0)
    print(f"[-] Leave VLAN {vlan}")

# 测试
for v in [10, 20, 100]:
    send_gvrp_join(v)